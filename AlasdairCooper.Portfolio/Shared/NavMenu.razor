@using System.Threading.Tasks
@using AlasdairCooper.Portfolio.Components.Nav

@inject NavigationManager _navMan

<style type="text/css">
	.mud-icon-button{
		padding: 1px;
	}
</style>

<MudNavMenu Margin="Margin.Dense" Color="Color.Primary" Class="pa-2 mb-3" Rounded Dense>
	@if (pages != null)
	{
		if (favourites != null && favourites.Count > 0)
		{
			foreach (var pageIndex in favourites)
			{
				var navPage = pages[pageIndex];

				<MudNavLink OnClick="() => LoadPage(navPage)" Match="NavLinkMatch.All" Icon="@navPage.Icon">
					<NavDetail Page="navPage" IsFavourite="true" OnFavouriteToggled="@((isFavourite) => ToggleFavourite(navPage.Id, isFavourite))" />
				</MudNavLink>
			}
			<MudDivider DividerType="DividerType.Middle" Class="my-2"/>
		}
		foreach (var navPage in pages.Where(page => !page.ParentPageId.HasValue))
		{
			<MudNavLink OnClick="() => LoadPage(navPage)" Match="NavLinkMatch.All" Icon="@navPage.Icon">
				<NavDetail Page="navPage" OnFavouriteToggled="@((isFavourite) => ToggleFavourite(navPage.Id, isFavourite))" />
			</MudNavLink>
		}
	}
</MudNavMenu>

@code {
	bool Favourited { get; set; } = false;

	NavPage[] pages = new NavPage[] { };
	public HashSet<int> favourites = new();

	protected override void OnInitialized()
	{
		pages = FetchPages();
		favourites = GetFavourites();
	}

	public void LoadPage(NavPage page)
	{
		_navService.SetCurrentPage(page);
		_navMan.NavigateTo(page.Url);
	}

	public NavPage[] FetchPages()
	{
		return new[]
		{
			new NavPage(_navService, "Home", 0, "/", Icons.Material.Filled.Home),
			new NavPage(_navService, "Counter", 1, "/counter", Icons.Material.Filled.Home),
			new NavPage(_navService, "Fetch data", 2, "/fetchdata", Icons.Material.Filled.Home)
		};
	}

	public HashSet<int> GetFavourites()
	{
		return new HashSet<int> { 0 };
	}

	private void ToggleFavourite(int pageId, bool isFavourite)
	{
		if (isFavourite)
		{
			favourites.Add(pageId);
		}
		else
		{
			favourites.Remove(pageId);
		}
	}
}